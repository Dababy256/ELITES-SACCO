<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Elites SACCO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#F3E9D2;margin:0}
header{background:#111;color:#fff;padding:12px;display:flex;align-items:center;gap:12px}
header img{height:45px;border-radius:6px}
.container{padding:16px;max-width:1200px;margin:auto}
.card{background:#fff;padding:12px;border-radius:8px;margin-bottom:16px}
h2{margin-top:0}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
th{background:#B08D57;color:#000}
button{padding:8px 12px;border:none;border-radius:6px;background:#111;color:#fff;cursor:pointer}
button.gold{background:#B08D57;color:#000}
button:disabled{opacity:0.5}
input,select{padding:6px;width:100%;margin-bottom:6px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
.status{padding:4px 8px;border-radius:6px;color:#fff}
.green{background:green}
.red{background:red}
</style>
</head>

<body>

<header>
  <img id="logoImg" style="display:none">
  <div>
    <strong>Elites SACCO</strong><br>
    <span id="userLabel"></span>
  </div>
  <span id="freezeStatus" class="status green">ACTIVE</span>
</header>

<div class="container" id="app"></div>

<script>
/* ========= CONFIG ========= */
const MEMBERS=["Gerald","Member 2","Member 3","Member 4","Member 5"];
const ADMIN_PIN="1234";
const INTEREST=0.05;

/* ========= STATE ========= */
let user=null;
let frozen=localStorage.getItem("frozen")==="true";
let data=JSON.parse(localStorage.getItem("sacco")||"{}");
let logo=localStorage.getItem("logo");

/* ========= INIT ========= */
MEMBERS.forEach(m=>{
  if(!data[m]) data[m]={contributions:[],loans:[]};
});
if(!data.expenses) data.expenses=[];

/* ========= HELPERS ========= */
  function downloadCSV(filename, rows) {
  const csv = rows.map(r =>
    r.map(v => `"${String(v ?? "").replace(/"/g,'""')}"`).join(",")
  ).join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

  function calculateLateFee(month, paymentDate) {
  if (!paymentDate) return 0;

  const dueDate = new Date(month + "-10");
  const paidDate = new Date(paymentDate);

  if (paidDate <= dueDate) return 0;

  const diffDays = Math.floor((paidDate - dueDate) / (1000 * 60 * 60 * 24));
  const weeksLate = Math.ceil(diffDays / 7);

  return Math.min(weeksLate * 5000, 15000);
}

function save(){localStorage.setItem("sacco",JSON.stringify(data))}
function pinCheck(cb){
  const p=prompt("Enter Admin PIN");
  if(p===ADMIN_PIN) cb(); else alert("Wrong PIN");
}
function monthsBetween(d){
  const s=new Date(d),e=new Date();
  return Math.max((e.getFullYear()-s.getFullYear())*12+(e.getMonth()-s.getMonth()),0);
}
function compound(p,m){return Math.round(p*Math.pow(1+INTEREST,m))}

/* ========= LOGIN ========= */
function login(name){
  user={name,role:name==="Gerald"?"admin":"member"};
  render();
}

/* ========= RENDER ========= */
function render(){
  document.getElementById("userLabel").textContent=user?user.name:"";
  document.getElementById("freezeStatus").textContent=frozen?"FROZEN":"ACTIVE";
  document.getElementById("freezeStatus").className="status "+(frozen?"red":"green");
  if(logo){
    const img=document.getElementById("logoImg");
    img.src=logo;img.style.display="block";
  }
  const app=document.getElementById("app");
  app.innerHTML="";

  if(!user){
    const c=document.createElement("div");c.className="card";
    MEMBERS.forEach(m=>{
      const b=document.createElement("button");
      b.textContent="Login as "+m;
      b.onclick=()=>login(m);
      c.appendChild(b);c.appendChild(document.createElement("br"));
    });
    app.appendChild(c);
    return;
  }

  /* DASHBOARD */
  let totalC=0,totalL=0,totalE=0;
  MEMBERS.forEach(m=>{
    data[m].contributions.forEach(r=>totalC+=r.paid);
    data[m].loans.forEach(l=>totalL+=l.balance);
  });
  data.expenses.forEach(e=>totalE+=e.amount);

  app.innerHTML+=`
  <div class="grid">
    <div class="card">Contributions<br><b>${totalC}</b></div>
    <div class="card">Loans<br><b>${totalL}</b></div>
    <div class="card">Expenses<br><b>${totalE}</b></div>
    <div class="card">Net<br><b>${totalC-totalL-totalE}</b></div>
  </div>`;

  /* ADMIN CONTROLS */
  if(user.role==="admin"){
    const a = document.createElement("div");
a.className = "card";
a.innerHTML = `
  <h2>Admin Controls</h2>

  <input type="file" id="logoUp"><br><br>

  <button onclick="pinCheck(()=>{frozen=!frozen;localStorage.setItem('frozen',frozen);render()})">
    ${frozen ? "Unfreeze" : "Freeze"} System
  </button>

  <br><br>

  <button class="gold" id="exportContributionsBtn">
  Export Contributions (CSV)
</button>
`;
app.appendChild(a);
    const exportBtn = document.getElementById("exportContributionsBtn");
if (exportBtn) {
  exportBtn.addEventListener("click", exportContributionsCSV);
}

    document.getElementById("logoUp").onchange=e=>{
      const r=new FileReader();
      r.onload=x=>{logo=x.target.result;localStorage.setItem("logo",logo);render()};
      r.readAsDataURL(e.target.files[0]);
    }
  }

  /* FORMS */
  if(user.role==="admin" && !frozen){
    const f=document.createElement("div");f.className="card";
    f.innerHTML=`
    <h2>Add Records</h2>
    <select id="mSel">${MEMBERS.map(m=>`<option>${m}</option>`)}</select>
    <input id="cMonth" placeholder="Month YYYY-MM">
<input id="cPaidDate" type="date">
<input id="cPaid" placeholder="Paid Amount">

    <button class="gold" onclick="pinCheck(addContribution)">Add Contribution</button>
    <hr>
    <input id="lAmt" placeholder="Loan Amount">
    <input id="lDate" type="date">
    <button class="gold" onclick="pinCheck(addLoan)">Add Loan</button>
    <hr>
    <input id="eDesc" placeholder="Expense Description">
    <input id="eAmt" placeholder="Expense Amount">
    <button class="gold" onclick="pinCheck(addExpense)">Add Expense</button>`;
    app.appendChild(f);
  }

  /* LEDGERS */
  renderContributionLedger(app);
  renderLoanLedger(app);
  renderExpenses(app);
}

/* ========= ACTIONS ========= */
function addContribution(){
  const m = mSel.value;
  const lateFee = calculateLateFee(cMonth.value, cPaidDate.value);

  data[m].contributions.push({
    month: cMonth.value,
    paid: Number(cPaid.value),
    paidDate: cPaidDate.value,
    lateFee: lateFee
  });

  save();
  render();
}

function addLoan(){
  const m=mSel.value;
  const bal=compound(Number(lAmt.value),monthsBetween(lDate.value));
  data[m].loans.push({principal:Number(lAmt.value),start:lDate.value,balance:bal});
  save();render();
}
function addExpense(){
  function exportContributionsCSV() {
    alert("Export function triggered");
  const rows = [
    ["Member", "Month", "Paid Amount", "Late Fee"]
  ];

  MEMBERS.forEach(member => {
    data[member].contributions.forEach(r => {
      rows.push([
        member,
        r.month,
        r.paid,
        r.lateFee || 0
      ]);
    });
  });

  downloadCSV("elites_contributions.csv", rows);
}
  window.exportContributionsCSV = exportContributionsCSV;

  data.expenses.push({desc:eDesc.value,amount:Number(eAmt.value)});
  save();render();
}

/* ========= LEDGERS ========= */
function renderContributionLedger(app){
 let html = `<div class="card">
  <h2>Contribution Ledger</h2>
  <table>
    <tr>
      <th>Member</th>
      <th>Month</th>
      <th>Paid</th>
      <th>Late Fee</th>
    </tr>`;

MEMBERS.forEach(m => {
  data[m].contributions.forEach(r => {
    html += `<tr>
      <td>${m}</td>
      <td>${r.month}</td>
      <td>${r.paid}</td>
      <td>${r.lateFee || 0}</td>
    </tr>`;
  });
});

html += `</table></div>`;
app.innerHTML += html;

  app.innerHTML+=html;
}
function renderLoanLedger(app){
  let html=`<div class="card"><h2>Loan Ledger</h2><table>
  <tr><th>Member</th><th>Principal</th><th>Balance</th></tr>`;
  MEMBERS.forEach(m=>data[m].loans.forEach(l=>{
    html+=`<tr><td>${m}</td><td>${l.principal}</td><td>${l.balance}</td></tr>`;
  }));
  html+=`</table></div>`;
  app.innerHTML+=html;
}
function renderExpenses(app){
  let html=`<div class="card"><h2>Expenses</h2><table>
  <tr><th>Description</th><th>Amount</th></tr>`;
  data.expenses.forEach(e=>{
    html+=`<tr><td>${e.desc}</td><td>${e.amount}</td></tr>`;
  });
  html+=`</table></div>`;
  app.innerHTML+=html;
}

/* ========= START ========= */
render();
</script>
</body>
</html>












