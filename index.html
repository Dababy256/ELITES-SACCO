<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Elites SACCO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        gold: "#B08D57",
        goldlight: "#F3E9D2",
        dark: "#111111"
      }
    }
  }
}
</script>

<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-goldlight">
<div id="root"></div>

<script type="text/babel">

/* ================= CONFIG ================= */
const MEMBERS = ["Gerald","Member 2","Member 3","Member 4","Member 5"];
const ADMIN_PIN = "1234";
const INTEREST = 0.05;

/* ================= HELPERS ================= */
const monthsBetween = (start) => {
  const s = new Date(start);
  const e = new Date();
  return Math.max(
    (e.getFullYear()-s.getFullYear())*12 + (e.getMonth()-s.getMonth()),
    0
  );
};
const compound = (p,m)=>Math.round(p*Math.pow(1+INTEREST,m));

/* ================= APP ================= */
function App(){
  const [user,setUser]=React.useState(null);
  const [data,setData]=React.useState({});
  const [frozen,setFrozen]=React.useState(localStorage.getItem("sacco_frozen")==="true");
  const [askPin,setAskPin]=React.useState(false);
  const [pin,setPin]=React.useState("");
  const [afterPin,setAfterPin]=React.useState(null);

  const [form,setForm]=React.useState({
    member:"",
    month:"",
    amount:"",
    loanAmount:"",
    loanDate:"",
    repayAmount:"",
    expenseAmount:"",
    expenseDesc:""
  });

  React.useEffect(()=>{
    const raw=localStorage.getItem("elites_sacco");
    let d=raw?JSON.parse(raw):{};
    MEMBERS.forEach(m=>{
      if(!d[m]) d[m]={ledger:[],loans:[]};
      d[m].loans.forEach(l=>{
        if(!l.status) l.status=l.currentBalance>0?"ACTIVE":"CLEARED";
      });
    });
    if(!Array.isArray(d.expenses)) d.expenses=[];
    setData(d);
    localStorage.setItem("elites_sacco",JSON.stringify(d));
  },[]);

  const save=d=>{
    setData(d);
    localStorage.setItem("elites_sacco",JSON.stringify(d));
  };

  const requirePin=(action)=>{
    setAfterPin(()=>action);
    setPin("");
    setAskPin(true);
  };

  const verifyPin=()=>{
    if(pin===ADMIN_PIN){
      setAskPin(false);
      afterPin && afterPin();
      setAfterPin(null);
    } else alert("Wrong PIN");
  };

  /* ===== ADD FUNCTIONS ===== */
  const addContribution=()=>{
    const d={...data};
    d[form.member].ledger.push({
      month: form.month,
      paid: Number(form.amount)
    });
    save(d);
  };

  const addLoan=()=>{
    const months=monthsBetween(form.loanDate);
    const bal=compound(Number(form.loanAmount),months);
    const d={...data};
    d[form.member].loans.push({
      principal:Number(form.loanAmount),
      startDate:form.loanDate,
      currentBalance:bal,
      status:"ACTIVE"
    });
    save(d);
  };

  const addExpense=()=>{
    const d={...data};
    d.expenses.push({
      date:new Date().toISOString().slice(0,10),
      description:form.expenseDesc,
      amount:Number(form.expenseAmount)
    });
    save(d);
  };

  /* ===== LOGIN ===== */
  if(!user){
    return (
      <div className="p-8 max-w-md mx-auto text-center">
        <h1 className="text-3xl font-bold mb-6">Elites SACCO</h1>
        {MEMBERS.map(m=>(
          <button key={m}
            className="w-full mb-3 bg-dark text-white p-3 rounded"
            onClick={()=>setUser({name:m,role:m==="Gerald"?"admin":"member"})}>
            Login as {m}
          </button>
        ))}
      </div>
    );
  }

  return (
    <div className="p-4 max-w-6xl mx-auto">

      <header className="bg-dark text-white p-4 rounded-xl mb-4 flex justify-between">
        <h1 className="text-2xl font-bold">Elites SACCO</h1>
        <span className={`px-2 py-1 rounded ${frozen?"bg-red-600":"bg-green-600"}`}>
          {frozen?"FROZEN":"ACTIVE"}
        </span>
      </header>

      {/* ===== ADMIN FORMS ===== */}
      {user.role==="admin" && !frozen && (
        <div className="bg-white p-4 rounded-xl mb-4 space-y-3">
          <h2 className="font-bold">Admin Entry</h2>

          <select className="border p-2 w-full"
            onChange={e=>setForm({...form,member:e.target.value})}>
            <option value="">Select Member</option>
            {MEMBERS.map(m=><option key={m}>{m}</option>)}
          </select>

          <input className="border p-2 w-full" placeholder="Contribution Month (YYYY-MM)"
            onChange={e=>setForm({...form,month:e.target.value})} />
          <input className="border p-2 w-full" placeholder="Contribution Amount"
            onChange={e=>setForm({...form,amount:e.target.value})} />

          <button className="bg-gold p-2 w-full"
            onClick={()=>requirePin(addContribution)}>
            Add Contribution
          </button>

          <input className="border p-2 w-full" placeholder="Loan Amount"
            onChange={e=>setForm({...form,loanAmount:e.target.value})} />
          <input type="date" className="border p-2 w-full"
            onChange={e=>setForm({...form,loanDate:e.target.value})} />

          <button className="bg-gold p-2 w-full"
            onClick={()=>requirePin(addLoan)}>
            Add Loan
          </button>

          <input className="border p-2 w-full" placeholder="Expense Description"
            onChange={e=>setForm({...form,expenseDesc:e.target.value})} />
          <input className="border p-2 w-full" placeholder="Expense Amount"
            onChange={e=>setForm({...form,expenseAmount:e.target.value})} />

          <button className="bg-gold p-2 w-full"
            onClick={()=>requirePin(addExpense)}>
            Add Expense
          </button>
        </div>
      )}

      {/* ===== MEMBERS VIEW ===== */}
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {MEMBERS.map(m=>(
          <div key={m} className="bg-white p-4 rounded shadow">
            <h3 className="font-semibold">{m}</h3>
            <p className="text-sm">Contributions: {data[m].ledger.length}</p>
            <p className="text-sm">Loans: {data[m].loans.length}</p>
          </div>
        ))}
      </div>

      {/* PIN */}
      {askPin && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
          <div className="bg-white p-4 rounded w-64">
            <h3 className="font-bold mb-2">Admin PIN</h3>
            <input type="password" className="border p-2 w-full mb-2"
              value={pin} onChange={e=>setPin(e.target.value)} />
            <button className="bg-dark text-white p-2 w-full rounded"
              onClick={verifyPin}>Confirm</button>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
