<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elites SACCO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: '#B08D57',
            goldlight: '#F3E9D2',
            dark: '#111111'
          }
        }
      }
    }
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-goldlight">
<div id="root"></div>

<script type="text/babel">

/* ================= CONFIG ================= */
const MEMBERS = ["Gerald","Member 2","Member 3","Member 4","Member 5"];
const ADMIN_PIN = "1234";

/* ================= APP ================= */
function App() {
  const [user, setUser] = React.useState(null);
  const [data, setData] = React.useState({});
  const [logo, setLogo] = React.useState(localStorage.getItem("sacco_logo"));
  const [photos, setPhotos] = React.useState(
    JSON.parse(localStorage.getItem("member_photos") || "{}")
  );

  /* -------- INIT -------- */
  React.useEffect(() => {
    const raw = localStorage.getItem("elites_sacco");
    let parsed = raw ? JSON.parse(raw) : {};

    MEMBERS.forEach(m => {
      if (!parsed[m]) parsed[m] = {};
      if (!Array.isArray(parsed[m].ledger)) parsed[m].ledger = [];
      if (!Array.isArray(parsed[m].loans)) parsed[m].loans = [];

      // ðŸ”§ Normalize loan status (fixes UNDEFINED)
      parsed[m].loans.forEach(l => {
        if (!l.status) {
          l.status = l.currentBalance > 0 ? "ACTIVE" : "CLEARED";
        }
      });
    });

    if (!Array.isArray(parsed.expenses)) parsed.expenses = [];
    setData(parsed);
    localStorage.setItem("elites_sacco", JSON.stringify(parsed));
  }, []);

  /* -------- IMAGE HELPERS -------- */
  const readImage = (file, callback) => {
    const reader = new FileReader();
    reader.onload = e => callback(e.target.result);
    reader.readAsDataURL(file);
  };

  const uploadLogo = file => {
    readImage(file, img => {
      localStorage.setItem("sacco_logo", img);
      setLogo(img);
    });
  };

  const uploadPhoto = (member, file) => {
    readImage(file, img => {
      const updated = { ...photos, [member]: img };
      localStorage.setItem("member_photos", JSON.stringify(updated));
      setPhotos(updated);
    });
  };

  /* -------- LOGIN -------- */
  if (!user) {
    return (
      <div className="p-8 max-w-md mx-auto text-center">
        {logo && <img src={logo} className="mx-auto h-20 mb-4 rounded" />}
        <h1 className="text-3xl font-bold text-dark mb-6">Elites SACCO</h1>
        {MEMBERS.map(m => (
          <button key={m}
            className="w-full mb-3 bg-dark text-white p-3 rounded-lg hover:bg-gold"
            onClick={() => setUser({ name: m, role: m === "Gerald" ? "admin" : "member" })}>
            Login as {m}
          </button>
        ))}
      </div>
    );
  }

  return (
    <div className="p-4 max-w-6xl mx-auto">
      {/* ===== HEADER ===== */}
      <header className="bg-dark text-white p-4 rounded-xl mb-6 flex items-center gap-4">
        {logo && <img src={logo} className="h-12 rounded" />}
        <div>
          <h1 className="text-2xl font-bold">Elites SACCO</h1>
          <p className="text-gold text-sm">Logged in as {user.name}</p>
        </div>
      </header>

      {/* ===== LOGO UPLOAD ===== */}
      {user.role === "admin" && (
        <div className="bg-white p-4 rounded-xl shadow mb-6">
          <h2 className="font-semibold mb-2">SACCO Branding</h2>
          <label className="block mb-2">
            Upload SACCO Logo:
            <input type="file" accept="image/*"
              onChange={e => uploadLogo(e.target.files[0])}
              className="block mt-1" />
          </label>
        </div>
      )}

      {/* ===== MEMBERS ===== */}
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {MEMBERS.map(m => (
          <div key={m} className="bg-white p-4 rounded-xl shadow flex gap-4 items-center">
            <div>
              {photos[m] ? (
                <img src={photos[m]} className="h-14 w-14 rounded-full object-cover" />
              ) : (
                <div className="h-14 w-14 rounded-full bg-gold flex items-center justify-center text-white">
                  {m[0]}
                </div>
              )}
              {user.role==="admin" && (
                <input type="file" accept="image/*"
                  className="text-xs mt-1"
                  onChange={e => uploadPhoto(m, e.target.files[0])} />
              )}
            </div>
            <div>
              <h3 className="font-semibold">{m}</h3>
              <p className="text-sm text-gray-600">
                Loans: {data[m].loans.filter(l=>l.status==="ACTIVE").length} active
              </p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
