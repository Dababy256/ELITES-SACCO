<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elites SACCO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

/* ================= CONFIG ================= */
const MEMBERS = ["Gerald","Member 2","Member 3","Member 4","Member 5"];
const ADMIN_PIN = "1234";
const WEEKLY_LATE_FEE = 5000;
const MAX_LATE_FEE = 15000;

const CONTRIBUTION_RULES = [
  { from: "2024-02", to: "2024-07", amount: 80000 },
  { from: "2024-08", to: "2025-12", amount: 100000 }
];

/* ================= HELPERS ================= */
const getContributionForMonth = ym =>
  (CONTRIBUTION_RULES.find(r => ym >= r.from && ym <= r.to) || {}).amount || 0;

const calculateLateFee = (ym, paidDate) => {
  const due = new Date(ym + "-10");
  const paid = new Date(paidDate);
  if (paid <= due) return 0;
  const weeks = Math.min(Math.ceil((paid - due) / (1000*60*60*24*7)), 3);
  return Math.min(weeks * WEEKLY_LATE_FEE, MAX_LATE_FEE);
};

const monthsBetween = (start, end) => {
  const res = [];
  let d = new Date(start + "-01");
  const e = new Date(end + "-01");
  while (d <= e) {
    res.push(d.toISOString().slice(0,7));
    d.setMonth(d.getMonth() + 1);
  }
  return res;
};

/* ================= APP ================= */
function App() {
  const [user, setUser] = React.useState(null);
  const [data, setData] = React.useState({});
  const [ledgerView, setLedgerView] = React.useState(null);

  const [askPin, setAskPin] = React.useState(false);
  const [pinValue, setPinValue] = React.useState("");
  const [afterPinAction, setAfterPinAction] = React.useState(null);

  const [bulk, setBulk] = React.useState({
    member: "",
    start: "",
    end: "",
    paidLate: false
  });

  /* -------- INIT -------- */
  React.useEffect(() => {
    const raw = localStorage.getItem("elites_sacco");
    let parsed = raw ? JSON.parse(raw) : {};
    MEMBERS.forEach(m => {
      if (!parsed[m]) parsed[m] = {};
      if (!Array.isArray(parsed[m].ledger)) parsed[m].ledger = [];
      if (typeof parsed[m].loan !== "number") parsed[m].loan = 0;
    });
    if (!Array.isArray(parsed.expenses)) parsed.expenses = [];
    setData(parsed);
    localStorage.setItem("elites_sacco", JSON.stringify(parsed));
  }, []);

  const save = d => {
    setData(d);
    localStorage.setItem("elites_sacco", JSON.stringify(d));
  };

  /* -------- PIN -------- */
  const requestPinThen = action => {
    setAfterPinAction(() => action);
    setPinValue("");
    setAskPin(true);
  };

  const verifyPin = () => {
    if (pinValue === ADMIN_PIN) {
      setAskPin(false);
      if (afterPinAction) afterPinAction();
      setAfterPinAction(null);
    } else alert("Incorrect PIN");
  };

  /* -------- BULK ENTRY -------- */
  const runBulkEntry = () => {
    const { member, start, end, paidLate } = bulk;
    if (!member || !start || !end) {
      alert("Fill all fields");
      return;
    }

    const months = monthsBetween(start, end);
    const nd = { ...data };
    let added = 0, skipped = 0;

    months.forEach(ym => {
      if (nd[member].ledger.some(r => r.month === ym)) {
        skipped++;
        return;
      }
      const expected = getContributionForMonth(ym);
      const datePaid = paidLate ? `${ym}-25` : `${ym}-10`;
      const lateFee = paidLate ? calculateLateFee(ym, datePaid) : 0;

      nd[member].ledger.push({
        month: ym,
        expected,
        paid: expected,
        lateFee,
        datePaid
      });
      added++;
    });

    save(nd);
    alert(`${added} month(s) added, ${skipped} skipped`);
  };

  /* -------- LOGIN -------- */
  if (!user) {
    return (
      <div className="p-6 max-w-md mx-auto">
        <h1 className="text-2xl font-bold mb-4">Elites SACCO Login</h1>
        {MEMBERS.map(m => (
          <button key={m}
            className="w-full mb-2 bg-black text-white p-2 rounded"
            onClick={() => setUser({ name: m, role: m === "Gerald" ? "admin" : "member" })}>
            Login as {m}
          </button>
        ))}
      </div>
    );
  }

  /* -------- TOTALS -------- */
  const totals = MEMBERS.reduce((a,m)=>{
    data[m].ledger.forEach(r=>{
      a.contributions += r.paid;
      a.lateFees += r.lateFee;
    });
    a.loans += data[m].loan;
    return a;
  },{contributions:0,lateFees:0,loans:0});

  return (
    <div className="p-4 max-w-5xl mx-auto">
      <h1 className="text-3xl font-bold mb-2">Elites SACCO</h1>
      <p className="mb-4 text-sm">Logged in as {user.name}</p>

      {/* ===== HISTORICAL BULK ENTRY ===== */}
      {user.role==="admin" && (
        <div className="bg-white p-4 rounded shadow mb-6">
          <h2 className="font-semibold mb-2">Historical Contribution Entry (Bulk)</h2>

          <select className="border p-1 w-full mb-2"
            onChange={e=>setBulk({...bulk,member:e.target.value})}>
            <option value="">Select Member</option>
            {MEMBERS.map(m=><option key={m}>{m}</option>)}
          </select>

          <div className="flex gap-2 mb-2">
            <input type="month" className="border p-1 w-1/2"
              onChange={e=>setBulk({...bulk,start:e.target.value})}/>
            <input type="month" className="border p-1 w-1/2"
              onChange={e=>setBulk({...bulk,end:e.target.value})}/>
          </div>

          <label className="text-sm block mb-2">
            <input type="checkbox"
              onChange={e=>setBulk({...bulk,paidLate:e.target.checked})}/> Paid late
          </label>

          <button className="bg-black text-white p-2 w-full rounded"
            onClick={()=>requestPinThen(runBulkEntry)}>
            Apply Bulk Entry
          </button>
        </div>
      )}

      {/* ===== MEMBERS ===== */}
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {MEMBERS.map(m=>(
          <div key={m} className="bg-white p-4 rounded shadow">
            <h3 className="font-semibold">{m}</h3>
            <p>Total Paid: {data[m].ledger.reduce((a,b)=>a+b.paid,0)}</p>
            <p>Late Fees: {data[m].ledger.reduce((a,b)=>a+b.lateFee,0)}</p>
            <button className="underline text-sm"
              onClick={()=>setLedgerView(m)}>
              View Ledger
            </button>
          </div>
        ))}
      </div>

      {/* ===== LEDGER ===== */}
      {ledgerView && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
          <div className="bg-white p-4 rounded max-w-3xl w-full">
            <h3 className="font-bold mb-2">{ledgerView} Ledger</h3>
            <table className="w-full text-sm border">
              <thead className="bg-gray-100">
                <tr>
                  <th className="border p-1">Month</th>
                  <th className="border p-1">Expected</th>
                  <th className="border p-1">Paid</th>
                  <th className="border p-1">Late Fee</th>
                  <th className="border p-1">Date</th>
                </tr>
              </thead>
              <tbody>
                {data[ledgerView].ledger.map((r,i)=>(
                  <tr key={i}>
                    <td className="border p-1">{r.month}</td>
                    <td className="border p-1">{r.expected}</td>
                    <td className="border p-1">{r.paid}</td>
                    <td className="border p-1">{r.lateFee}</td>
                    <td className="border p-1">{r.datePaid}</td>
                  </tr>
                ))}
              </tbody>
            </table>
            <button className="mt-2 underline w-full"
              onClick={()=>setLedgerView(null)}>Close</button>
          </div>
        </div>
      )}

      {/* ===== PIN ===== */}
      {askPin && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
          <div className="bg-white p-4 rounded max-w-xs w-full">
            <h3 className="font-bold mb-2">Enter Admin PIN</h3>
            <input type="password" className="border p-2 w-full mb-2"
              value={pinValue} onChange={e=>setPinValue(e.target.value)} />
            <button className="bg-black text-white p-2 w-full rounded"
              onClick={verifyPin}>Verify</button>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
