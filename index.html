<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elites SACCO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            gold: '#B08D57',
            goldlight: '#F3E9D2',
            dark: '#111111'
          }
        }
      }
    }
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-goldlight">
<div id="root"></div>

<script type="text/babel">

/* ================= CONFIG ================= */
const MEMBERS = ["Gerald","Member 2","Member 3","Member 4","Member 5"];
const ADMIN_PIN = "1234";
const WEEKLY_LATE_FEE = 5000;
const MAX_LATE_FEE = 15000;

const CONTRIBUTION_RULES = [
  { from: "2024-02", to: "2024-07", amount: 80000 },
  { from: "2024-08", to: "2025-12", amount: 100000 }
];

/* ================= HELPERS ================= */
const getContributionForMonth = ym =>
  (CONTRIBUTION_RULES.find(r => ym >= r.from && ym <= r.to) || {}).amount || 0;

const calculateLateFee = (ym, paidDate) => {
  const due = new Date(ym + "-10");
  const paid = new Date(paidDate);
  if (paid <= due) return 0;
  const weeks = Math.min(Math.ceil((paid - due) / (1000*60*60*24*7)), 3);
  return Math.min(weeks * WEEKLY_LATE_FEE, MAX_LATE_FEE);
};

/* ================= APP ================= */
function App() {
  const [user,setUser] = React.useState(null);
  const [data,setData] = React.useState({});
  const [ledgerView,setLedgerView] = React.useState(null);
  const [ledgerYear,setLedgerYear] = React.useState("ALL");
  const [askPin,setAskPin] = React.useState(false);
  const [pinValue,setPinValue] = React.useState("");
  const [afterPinAction,setAfterPinAction] = React.useState(null);
  const [manual,setManual] = React.useState({member:"",month:"",paid:"",date:""});

  React.useEffect(()=>{
    const raw = localStorage.getItem("elites_sacco");
    let parsed = raw ? JSON.parse(raw) : {};
    MEMBERS.forEach(m=>{
      if(!parsed[m]) parsed[m]={ledger:[],loan:0};
    });
    setData(parsed);
    localStorage.setItem("elites_sacco", JSON.stringify(parsed));
  },[]);

  const save = d => {
    setData(d);
    localStorage.setItem("elites_sacco", JSON.stringify(d));
  };

  const requestPinThen = action => {
    setAfterPinAction(()=>action);
    setPinValue("");
    setAskPin(true);
  };

  const verifyPin = () => {
    if(pinValue===ADMIN_PIN){
      setAskPin(false);
      afterPinAction && afterPinAction();
      setAfterPinAction(null);
    } else alert("Incorrect PIN");
  };

  if(!user){
    return (
      <div className="p-8 max-w-md mx-auto">
        <h1 className="text-3xl font-bold text-dark mb-6 text-center">Elites SACCO</h1>
        {MEMBERS.map(m=>(
          <button key={m}
            className="w-full mb-3 bg-dark text-white p-3 rounded-lg hover:bg-gold transition"
            onClick={()=>setUser({name:m,role:m==="Gerald"?"admin":"member"})}>
            Login as {m}
          </button>
        ))}
      </div>
    );
  }

  const lifetimeTotals = m =>
    m.ledger.reduce((a,r)=>{a.paid+=r.paid;a.late+=r.lateFee;return a;},{paid:0,late:0});

  return (
    <div className="p-4 max-w-6xl mx-auto">
      <header className="bg-dark text-white p-4 rounded-xl mb-6 flex justify-between items-center">
        <h1 className="text-2xl font-bold">Elites SACCO</h1>
        <span className="text-sm text-gold">Logged in as {user.name}</span>
      </header>

      {user.role==="admin" && (
        <div className="bg-white border-l-4 border-gold p-4 rounded-xl mb-6">
          <h2 className="font-semibold text-dark mb-3">Manual Contribution Entry</h2>

          <select className="border p-2 w-full mb-2"
            onChange={e=>setManual({...manual,member:e.target.value})}>
            <option value="">Select Member</option>
            {MEMBERS.map(m=><option key={m}>{m}</option>)}
          </select>

          <input type="month" className="border p-2 w-full mb-2"
            onChange={e=>setManual({...manual,month:e.target.value})} />

          <input type="number" placeholder="Amount paid"
            className="border p-2 w-full mb-2"
            onChange={e=>setManual({...manual,paid:e.target.value})} />

          <input type="date" className="border p-2 w-full mb-2"
            onChange={e=>setManual({...manual,date:e.target.value})} />

          <button className="bg-dark text-white p-2 w-full rounded-lg hover:bg-gold"
            onClick={()=>requestPinThen(()=>{
              const {member,month,paid,date}=manual;
              if(data[member].ledger.some(r=>r.month===month)){
                alert("Month already exists"); return;
              }
              const expected=getContributionForMonth(month);
              const lateFee=calculateLateFee(month,date);
              const nd={...data};
              nd[member].ledger.push({
                month,expected,paid:Number(paid),lateFee,
                status:Number(paid)>=expected?"COMPLETE":"INCOMPLETE"
              });
              save(nd);
              alert("Entry saved");
            })}>
            Save Entry
          </button>
        </div>
      )}

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {MEMBERS.map(m=>{
          const t=lifetimeTotals(data[m]);
          return (
            <div key={m} className="bg-white p-4 rounded-xl shadow">
              <h3 className="font-semibold text-dark">{m}</h3>
              <p>Total Paid: <span className="font-semibold">{t.paid}</span></p>
              <p>Late Fees: <span className="font-semibold text-red-600">{t.late}</span></p>
              <button className="underline text-sm text-gold"
                onClick={()=>{setLedgerView(m);setLedgerYear("ALL");}}>
                View Ledger
              </button>
            </div>
          );
        })}
      </div>

      {ledgerView && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
          <div className="bg-white p-4 rounded-xl max-w-4xl w-full">
            <h3 className="font-bold mb-2 text-dark">{ledgerView} Ledger</h3>

            <select className="border p-2 mb-2"
              onChange={e=>setLedgerYear(e.target.value)}>
              <option value="ALL">All years</option>
              {[...new Set(data[ledgerView].ledger.map(r=>r.month.slice(0,4)))]
                .map(y=><option key={y}>{y}</option>)}
            </select>

            <table className="w-full text-sm border">
              <thead className="bg-gold text-white">
                <tr>
                  <th className="border p-1">Month</th>
                  <th className="border p-1">Expected</th>
                  <th className="border p-1">Paid</th>
                  <th className="border p-1">Late</th>
                  <th className="border p-1">Status</th>
                </tr>
              </thead>
              <tbody>
                {data[ledgerView].ledger
                  .filter(r=>ledgerYear==="ALL"||r.month.startsWith(ledgerYear))
                  .map((r,i)=>(
                  <tr key={i} className="text-center">
                    <td className="border p-1">{r.month}</td>
                    <td className="border p-1">{r.expected}</td>
                    <td className="border p-1">{r.paid}</td>
                    <td className="border p-1">{r.lateFee}</td>
                    <td className={`border p-1 font-semibold ${r.status==="COMPLETE"?"text-green-600":"text-amber-600"}`}>
                      {r.status}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

            <button className="mt-3 underline text-gold w-full"
              onClick={()=>setLedgerView(null)}>Close</button>
          </div>
        </div>
      )}

      {askPin && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
          <div className="bg-white p-4 rounded-xl max-w-xs w-full">
            <h3 className="font-bold mb-2">Admin PIN</h3>
            <input type="password" className="border p-2 w-full mb-2"
              value={pinValue} onChange={e=>setPinValue(e.target.value)} />
            <button className="bg-dark text-white p-2 w-full rounded-lg"
              onClick={verifyPin}>Verify</button>
          </div>
        </div>
      )}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
