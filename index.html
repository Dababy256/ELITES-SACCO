<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Elites SACCO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

/* ------------------ CONFIG ------------------ */
const MEMBERS = ["Gerald","Member 2","Member 3","Member 4","Member 5"];
const DEFAULT_ADMIN_PIN = "1234";
const WEEKLY_LATE_FEE = 5000;
const MAX_LATE_FEE = 15000;
const LOAN_INTEREST = 0.05;

const CONTRIBUTION_RULES = [
  { from: "2024-02", to: "2024-07", amount: 80000 },
  { from: "2024-08", to: "2025-08", amount: 100000 }
];

/* ------------------ HELPERS ------------------ */
const getContributionForMonth = ym =>
  (CONTRIBUTION_RULES.find(r => ym >= r.from && ym <= r.to) || {}).amount || 0;

const calculateLateFee = (ym, paidDate) => {
  if (!paidDate) return 0;
  const due = new Date(ym + "-10");
  const paid = new Date(paidDate);
  if (paid <= due) return 0;
  const weeks = Math.min(Math.ceil((paid - due) / (1000*60*60*24*7)), 3);
  return Math.min(weeks * WEEKLY_LATE_FEE, MAX_LATE_FEE);
};

const calculateLoanBalance = (principal, startDate) => {
  const s = new Date(startDate), n = new Date();
  let m = (n.getFullYear()-s.getFullYear())*12 + (n.getMonth()-s.getMonth());
  m = Math.max(m,0);
  let b = principal;
  for(let i=0;i<m;i++) b *= 1+LOAN_INTEREST;
  return Math.round(b);
};

/* ------------------ APP ------------------ */
function App() {
  const [user,setUser] = React.useState(null);
  const [data,setData] = React.useState({});
  const [form,setForm] = React.useState(null);
  const [pinPrompt,setPinPrompt] = React.useState(null);
  const [pinInput,setPinInput] = React.useState("");

  React.useEffect(()=>{
    const s = localStorage.getItem("elites_sacco");
    const p = localStorage.getItem("admin_pin");
    if(!p) localStorage.setItem("admin_pin", DEFAULT_ADMIN_PIN);

    if(s) setData(JSON.parse(s));
    else {
      const d = {};
      MEMBERS.forEach(m=>d[m]={contributions:0,lateFees:0,loan:0});
      d.expenses=[];
      save(d);
    }
  },[]);

  const save = d => {
    setData(d);
    localStorage.setItem("elites_sacco", JSON.stringify(d));
  };

  const requirePin = (action) => {
    setPinPrompt({ action });
    setPinInput("");
  };

  const verifyPin = () => {
    const savedPin = localStorage.getItem("admin_pin");
    if(pinInput === savedPin){
      pinPrompt.action();
      setPinPrompt(null);
    } else {
      alert("Incorrect PIN");
    }
  };

  if(!user){
    return (
      <div className="p-6 max-w-md mx-auto">
        <h1 className="text-2xl font-bold mb-4">Elites SACCO Login</h1>
        {MEMBERS.map(m=>(
          <button key={m}
            className="w-full mb-2 bg-black text-white p-2 rounded"
            onClick={()=>setUser({name:m,role:m==="Gerald"?"admin":"member"})}>
            Login as {m}
          </button>
        ))}
      </div>
    );
  }

  const totals = {
    contrib:Object.values(data).reduce((a,b)=>a+(b.contributions||0),0),
    loans:Object.values(data).reduce((a,b)=>a+(b.loan||0),0),
    expenses:(data.expenses||[]).reduce((a,b)=>a+b.amount,0)
  };

  return (
    <div className="p-4 max-w-4xl mx-auto">
      <h1 className="text-3xl font-bold">Elites SACCO</h1>
      <p className="text-sm mb-4">Logged in as {user.name}</p>

      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {MEMBERS.map(m=>(
          <div key={m} className="bg-white p-4 rounded shadow">
            <h2 className="font-semibold">{m}</h2>
            <p>Contributions: {data[m].contributions}</p>
            <p>Late Fees: {data[m].lateFees}</p>
            <p>Loan: {data[m].loan}</p>

            {user.role==="admin" && (
              <div className="mt-2 space-y-1">
                <button className="w-full bg-green-600 text-white p-1 rounded"
                  onClick={()=>requirePin(()=>setForm({type:"contribution",member:m}))}>
                  Add Contribution
                </button>
                <button className="w-full bg-blue-600 text-white p-1 rounded"
                  onClick={()=>requirePin(()=>setForm({type:"loan",member:m}))}>
                  Add Loan
                </button>
                <button className="w-full bg-gray-700 text-white p-1 rounded"
                  onClick={()=>requirePin(()=>setForm({type:"repay",member:m}))}>
                  Record Repayment
                </button>
              </div>
            )}
          </div>
        ))}
      </div>

      <div className="bg-white p-4 mt-6 rounded shadow">
        <p>Total Contributions: {totals.contrib}</p>
        <p>Total Loans: {totals.loans}</p>
        <p>Total Expenses: {totals.expenses}</p>
        <p className="font-bold">Net Balance: {totals.contrib - totals.loans - totals.expenses}</p>
      </div>

      {/* FORMS */}
      {form && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
          <div className="bg-white p-4 rounded max-w-sm w-full">
            <h3 className="font-bold mb-2">{form.type.toUpperCase()} â€“ {form.member}</h3>

            {form.type==="contribution" && (
              <>
                <input type="month" id="ym" className="border p-1 w-full mb-2"/>
                <input type="date" id="date" className="border p-1 w-full mb-2"/>
                <button className="bg-green-600 text-white p-2 w-full rounded"
                  onClick={()=>{
                    const exp=getContributionForMonth(ym.value);
                    const fee=calculateLateFee(ym.value,date.value);
                    const nd={...data};
                    nd[form.member].contributions+=exp;
                    nd[form.member].lateFees+=fee;
                    save(nd); setForm(null);
                  }}>Save</button>
              </>
            )}

            {form.type==="loan" && (
              <>
                <input type="number" id="amt" className="border p-1 w-full mb-2"/>
                <input type="date" id="ld" className="border p-1 w-full mb-2"/>
                <button className="bg-blue-600 text-white p-2 w-full rounded"
                  onClick={()=>{
                    const nd={...data};
                    nd[form.member].loan+=calculateLoanBalance(+amt.value,ld.value);
                    save(nd); setForm(null);
                  }}>Save</button>
              </>
            )}

            {form.type==="repay" && (
              <>
                <input type="number" id="rp" className="border p-1 w-full mb-2"/>
                <button className="bg-gray-700 text-white p-2 w-full rounded"
                  onClick={()=>{
                    const nd={...data};
                    nd[form.member].loan=Math.max(nd[form.member].loan-+rp.value,0);
                    save(nd); setForm(null);
                  }}>Save</button>
              </>
            )}

            <button className="mt-2 w-full underline" onClick={()=>setForm(null)}>Cancel</button>
          </div>
        </div>
      )}

      {/* PIN MODAL */}
      {pinPrompt && (
        <div className="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center">
          <div className="bg-white p-4 rounded max-w-xs w-full">
            <h3 className="font-bold mb-2">Enter Admin PIN</h3>
            <input
              type="password"
              className="border p-2 w-full mb-2"
              value={pinInput}
              onChange={e=>setPinInput(e.target.value)}
            />
            <button className="bg-black text-white p-2 w-full rounded" onClick={verifyPin}>
              Verify
            </button>
            <button className="mt-2 w-full underline" onClick={()=>setPinPrompt(null)}>
              Cancel
            </button>
          </div>
        </div>
      )}

    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

</script>
</body>
</html>
